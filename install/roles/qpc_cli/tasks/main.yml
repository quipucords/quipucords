---

- name: Set qpc version (RHEL/CentOS 6)
  set_fact:
    qpc_package_name: "qpc.el6.noarch.rpm"
  when:
    - qpc_package_name is not defined
    - is_rhel_centos_6

- name: Set qpc version (RHEL/CentOS 7)
  set_fact:
    qpc_package_name: "qpc.el7.noarch.rpm"
  when:
    - is_rhel_centos_7

- name: set qpc_rpm_local_path
  set_fact:
    qpc_rpm_local_path: "{{ pkg_install_dir }}{{ qpc_package_name }}"

- name: Check if local qpc rpm exists
  stat:
    path: "{{ qpc_rpm_local_path }}"
  register: find_qpc_rpm_local

- name: Install QPC from local path
  shell: rpm -Uvh --force "{{qpc_rpm_local_path}}"
  become: true
  when: find_qpc_rpm_local.stat.exists == true

- name: Set the default base URL for the qpc cli yum install
  set_fact:
    install_flag_cli_version: "{{ cli_version }}"
  when:
    - find_qpc_rpm_local.stat.exists == false
    - cli_version is defined

- name: Set the default base URL for the qpc cli yum install
  set_fact:
    cli_github_release_url: "https://github.com/quipucords/qpc/releases/download/{{ install_flag_cli_version }}"
  when:
    - find_qpc_rpm_local.stat.exists == false
    - install_flag_cli_version is defined

- name: Set the default base URL for the qpc cli yum install
  set_fact:
    cli_github_release_url: "https://github.com/quipucords/qpc/releases/latest/download"
  when:
    - find_qpc_rpm_local.stat.exists == false
    - install_flag_cli_version is not defined

- name: Install the latest version (QPC RHEL/Centos)
  yum:
    name: '{{ cli_github_release_url }}/{{ qpc_package_name }}'
    state: present
  become: true
  when:
    - find_qpc_rpm_local.stat.exists == false

- name: Configure QPC to talk to server
  shell: qpc server config --host 127.0.0.1 --port "{{ server_port }}"
  when:
    - install_server
