---

- name: Install CLI setting
  set_fact:
    install_cli: "{{ install_cli | bool | default(true) }}"
  when: install_cli is defined

- name: Defaulting CLI install setting
  set_fact:
    install_cli: true
  when: install_cli is not defined

- name: Find installable local QPC rpm
  find:
    paths: "{{ pkg_install_dir }}"
    patterns: 'qpc*.rpm'
  register: find_qpc_rpm_local_raw

- name: Set find_qpc_rpm_local
  set_fact:
    find_qpc_rpm_local: "{{ find_qpc_rpm_local_raw['matched'] == 1 }}"
  when:
    - find_qpc_rpm_local_raw is defined
    - "'matched' in find_qpc_rpm_local_raw"

- name: Set find_qpc_rpm_local_path
  set_fact:
    find_qpc_rpm_local_path: "{{ find_qpc_rpm_local_raw['files'][0]['path'] }}"
  when:
    - find_qpc_rpm_local is defined
    - find_qpc_rpm_local

- name: Install QPC from local path
  shell: rpm -Uvh --force "{{find_qpc_rpm_local_path}}"
  when: find_qpc_rpm_local

- name: Add QPC repository
  get_url:
    url: https://copr.fedorainfracloud.org/coprs/g/quipucords/qpc/repo/epel-7/group_quipucords-qpc-epel-7.repo
    dest: /etc/yum.repos.d/group_quipucords-qpc-epel-7.repo
    mode: 0644
    force: yes
  when:
    - install_cli
    - not find_qpc_rpm_local
    - is_rhel7

- name: Add QPC repository
  get_url:
    url: https://copr.fedorainfracloud.org/coprs/g/quipucords/qpc/repo/epel-6/group_quipucords-qpc-epel-6.repo
    dest: /etc/yum.repos.d/group_quipucords-qpc-epel-6.repo
    mode: 0644
    force: yes
  when:
    - install_cli
    - not find_qpc_rpm_local
    - is_rhel6

- name: Install the latest version of QPC
  yum:
    name: qpc
    state: latest
  when:
    - install_cli
    - not find_qpc_rpm_local

- name: Configure QPC to talk to server
  shell: qpc server config --host 127.0.0.1 --port "{{ server_port }}"
  when: install_cli
